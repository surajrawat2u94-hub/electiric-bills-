<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>UPCL Alerts — Auto from PDFs (Unofficial)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF.js + worker -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.5.136/pdf.worker.min.js";
    }
  </script>

  <style>
    .card{background:#fff;border:1px solid rgba(226,232,240,.9);border-radius:16px;box-shadow:0 10px 25px -10px rgba(2,6,23,.15)}
    .hint{font-size:.85rem;color:#64748b}
    .btn{padding:.6rem 1rem;border-radius:12px}
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <header class="bg-indigo-600 text-white">
    <div class="max-w-5xl mx-auto px-4 py-6">
      <h1 class="text-2xl font-bold">UPCL Alerts — Auto from PDFs</h1>
      <p class="opacity-90 text-sm mt-1">
        Upload your last 3 UPCL bills (PDF). We’ll auto-extract periods & units and enable SMS/Voice alerts on 50-unit steps.
      </p>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <!-- Preferences -->
    <section class="card p-5">
      <h2 class="text-xl font-semibold mb-3">1) Your Details</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium">Phone (10-digit)</label>
          <input id="phone" type="tel" maxlength="10" class="mt-1 w-full border rounded-lg px-3 py-2" placeholder="98XXXXXXXX"/>
        </div>
        <div>
          <label class="block text-sm font-medium">Channel</label>
          <select id="channel" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="both">SMS + Voice (default)</option>
            <option value="sms">SMS only</option>
            <option value="voice">Voice only</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">Language</label>
          <select id="lang" class="mt-1 w-full border rounded-lg px-3 py-2">
            <option value="en">English</option>
            <option value="hi">Hindi (हिन्दी)</option>
          </select>
        </div>
      </div>
      <div class="flex items-center gap-3 mt-3">
        <input id="consent" type="checkbox" class="h-4 w-4"/>
        <label for="consent" class="text-sm">I agree to receive alerts. This is an unofficial tool (no UPCL login required).</label>
      </div>
    </section>

    <!-- Upload & Auto Extract -->
    <section class="card p-5">
      <h2 class="text-xl font-semibold mb-3">2) Upload 3 UPCL PDFs</h2>
      <input id="files" type="file" accept="application/pdf" multiple class="block w-full text-sm"/>
      <p class="hint mt-2">Tip: Use original e-bills (text PDFs). Scanned photos won’t parse.</p>

      <div class="mt-4 flex gap-2">
        <button id="btnParse" class="btn bg-indigo-600 text-white hover:bg-indigo-700">Extract Automatically</button>
        <button id="btnClear" class="btn bg-slate-200 hover:bg-slate-300">Clear</button>
      </div>

      <div id="preview" class="mt-5 hidden">
        <h3 class="font-semibold mb-2">Detected History</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm border">
            <thead class="bg-slate-100">
              <tr>
                <th class="px-2 py-1 border text-left">Period Start</th>
                <th class="px-2 py-1 border text-left">Period End</th>
                <th class="px-2 py-1 border text-left">Units (kWh)</th>
                <th class="px-2 py-1 border text-left">Source</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <p id="avgInfo" class="mt-2 text-sm"></p>

        <div class="mt-4">
          <h4 class="font-semibold">Predicted crossing dates (next 400 units)</h4>
          <ul id="predList" class="list-disc pl-6 text-sm"></ul>
        </div>

        <div class="mt-4 flex flex-wrap gap-2">
          <button id="btnRegister" class="btn bg-emerald-600 text-white hover:bg-emerald-700">Enable Alerts</button>
          <span id="status" class="text-sm"></span>
        </div>
      </div>
    </section>

    <p class="hint">
      Not affiliated with UPCL. Extraction happens in your browser; only the summarized history is sent to the backend.
    </p>
  </main>

  <script>
    // ===== Replace with your Apps Script Web App URL =====
    const API = "YOUR_APPS_SCRIPT_WEB_APP_URL";

    // ---------- Helpers ----------
    const $  = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    function toast(el, msg, ok=true){ el.textContent = msg; el.className = ok ? "text-emerald-700" : "text-rose-700"; }
    async function postJSON(payload){
      const res = await fetch(API, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }
    function daysBetween(a,b){ const A=new Date(a), B=new Date(b); return Math.max(1, Math.round((B-A)/(1000*60*60*24))+1); }
    function formatISO(d){ const x=new Date(d); const z=new Date(Date.UTC(x.getFullYear(),x.getMonth(),x.getDate())); return z.toISOString().slice(0,10); }

    // ---------- PDF parsing ----------
    async function pdfToText(file){
      if(!window.pdfjsLib) throw new Error("PDF engine not loaded.");
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      let out = "";
      for(let i=1;i<=pdf.numPages;i++){
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        out += content.items.map(it => it.str).join("\n") + "\n";
      }
      return out;
    }

    // Robust UPCL extractor for English + fallback
    function parseUPCLText(raw){
      const text = raw.replace(/\r/g," ").replace(/\n+/g," ").replace(/\s{2,}/g," ").trim();

      // Dates (English section). Example in sample: "Bill Period From  31-07-2019" ... "Bill Period To  08-02-2020"
      function pick(re){ const m = text.match(re); return m ? m[1] : null; }
      let start = pick(/Bill\s*Period\s*From\s*([0-3]?\d[\/-][0-1]?\d[\/-]\d{2,4})/i);
      let end   = pick(/Bill\s*Period\s*To\s*([0-3]?\d[\/-][0-1]?\d[\/-]\d{2,4})/i);

      // Hindi (romanized in many PDFs) fallback: "fcy vofèk fnukad ls ... rd ..."
      if(!start) start = pick(/fcy\s*vof[a-z]*\s*fnukad\s*ls\s*([0-3]?\d[\/-][0-1]?\d[\/-]\d{4})/i);
      if(!end)   end   = pick(/fcy\s*vof[a-z]*\s*fnukad\s*rd\s*([0-3]?\d[\/-][0-1]?\d[\/-]\d{4})/i);

      // Units priority:
      // 1) Total Billable Unit  44
      let units = null, m;
      m = text.match(/Total\s*Billable\s*Unit\s+([0-9]+(?:\.[0-9]+)?)/i);
      if(m) units = parseFloat(m[1]);

      // 2) Metered Unit 44
      if(units===null){
        m = text.match(/Metered\s*Unit\s+([0-9]+(?:\.[0-9]+)?)/i);
        if(m) units = parseFloat(m[1]);
      }

      // 3) Pattern "... 7295/0  7339/0  44/0 ..." → capture third number
      if(units===null){
        m = text.match(/(\d+)\s*\/\s*0\s+(\d+)\s*\/\s*0\s+(\d+)\s*\/\s*0/);
        if(m) units = parseFloat(m[3]);
      }

      // 4) Generic "Units Consumed / Billed Units / Total Units"
      if(units===null){
        m = text.match(/(Units\s*Consumed|Billed\s*Units|Total\s*Units|Total\s*Consumption)\s*[:\-]?\s*([0-9]+(?:\.[0-9]+)?)/i);
        if(m) units = parseFloat(m[2]);
      }

      if(start && end && units!=null) return [{ start, end, units, source: "pdf" }];
      return [];
    }

    // Average + predicted crossings
    function avgDaily(history){
      let U=0, D=0; history.forEach(h=>{ U += Number(h.units)||0; D += daysBetween(h.start,h.end); });
      return D>0 ? U/D : 0;
    }
    function predictCrossings(cycleStart, avg, maxUnits=400, step=50){
      const out=[]; if(avg<=0) return out;
      for(let k=step;k<=maxUnits;k+=step){
        const daysNeeded = Math.ceil(k/avg);
        const dt = new Date(cycleStart); dt.setHours(0,0,0,0); dt.setDate(dt.getDate()+daysNeeded-1);
        out.push({ threshold:k, date: formatISO(dt) });
      }
      return out;
    }

    // ---------- UI ----------
    function fillTable(rows){
      const tbody = $("#tbody");
      tbody.innerHTML = "";
      rows.forEach(r=>{
        const tr = document.createElement("tr");
        tr.className = "border-b";
        tr.innerHTML = `
          <td class="border px-2 py-1">${r.start}</td>
          <td class="border px-2 py-1">${r.end}</td>
          <td class="border px-2 py-1">${Number(r.units).toFixed(2)}</td>
          <td class="border px-2 py-1">${r.source||""}</td>`;
        tbody.appendChild(tr);
      });
      $("#preview").classList.toggle("hidden", rows.length===0);
    }

    async function extractAll(){
      const files = Array.from($("#files").files||[]);
      const status = $("#status");
      if(!files.length){ toast(status,"Please select 3 UPCL PDFs.",false); return; }

      const btn = $("#btnParse"); const old = btn.textContent;
      btn.disabled = true; btn.textContent = "Extracting…";

      let all=[];
      try{
        for(const f of files){
          if(f.type!=="application/pdf") continue;
          const txt = await pdfToText(f);
          const rows = parseUPCLText(txt);
          // If a PDF contains multiple pages/sections, parser returns one row
          if(rows.length) all = all.concat(rows);
        }
      }catch(e){
        toast(status, "Error while reading PDFs: "+e.message, false);
      }finally{
        btn.disabled = false; btn.textContent = old;
      }

      // Deduplicate by (start,end); keep the last
      const key = r=>`${r.start}|${r.end}`;
      const map = new Map(); all.forEach(r=>map.set(key(r), r));
      const rows = Array.from(map.values()).sort((a,b)=> new Date(a.start) - new Date(b.start));

      fillTable(rows);

      if(!rows.length){
        toast(status, "Couldn’t auto-extract. Make sure these are text e-bills (not scanned photos).", false);
        $("#avgInfo").textContent = "";
        $("#predList").innerHTML = "";
        return;
      }

      const avg = avgDaily(rows);
      const cycleStartDefault = new Date(); cycleStartDefault.setDate(1);
      const cycleStart = $("#cycleStart").value || formatISO(cycleStartDefault);
      if(!$("#cycleStart").value) $("#cycleStart").value = cycleStart;

      $("#avgInfo").textContent = `Estimated average daily use: ${avg.toFixed(2)} units/day`;
      $("#predList").innerHTML = predictCrossings(cycleStart, avg, 400, 50)
        .map(p=>`<li>${p.threshold} units ≈ ${p.date}</li>`).join("");
      toast(status, "Extraction complete.", true);
    }

    $("#btnParse").addEventListener("click", extractAll);
    $("#files").addEventListener("change", extractAll); // auto-run on file select

    $("#btnClear").addEventListener("click", ()=>{
      $("#files").value = "";
      $("#tbody").innerHTML = "";
      $("#predList").innerHTML = "";
      $("#avgInfo").textContent = "";
      $("#status").textContent = "";
      $("#preview").classList.add("hidden");
    });

    $("#btnRegister").addEventListener("click", async ()=>{
      const status = $("#status");
      const phone = $("#phone").value.trim();
      const lang = $("#lang").value;
      const channel = $("#channel").value;
      const consent = $("#consent").checked;
      const cycleStart = $("#cycleStart").value || formatISO(new Date(new Date().getFullYear(), new Date().getMonth(), 1));

      if(!/^[6-9]\d{9}$/.test(phone)) return toast(status,"Enter a valid 10-digit Indian mobile starting with 6/7/8/9",false);
      if(!consent) return toast(status,"Please accept consent",false);

      // Collect table rows (already auto-filled)
      const rows = $$("#tbody tr").map(tr=>{
        const tds = tr.querySelectorAll("td");
        return { start: tds[0].textContent.trim(), end: tds[1].textContent.trim(), units: parseFloat(tds[2].textContent) };
      });
      if(!rows.length) return toast(status,"No history detected. Upload your PDFs first.",false);

      try{
        await postJSON({ op:"registerHistory", data:{ phone, lang, channel, account:"", cycleStart, history: rows }});
        toast(status,"Alerts enabled (prediction mode).",true);
      }catch(e){
        toast(status,"Failed: "+e.message,false);
      }
    });
  </script>
</body>
</html>
